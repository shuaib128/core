version: '1'
name: django-channels-railway

env:
  - WEB_CONCURRENCY=1
  - DJANGO_SETTINGS_MODULE=core.settings
  - PYTHONUNBUFFERED=1
  - REDISHOST=containers-us-west-92.railway.app
  - REDISPASSWORD=IBVhmzoCOZVoDLaOSul9
  - REDISPORT=5903
  - REDISUSER=default

build:
  dockerfile: Dockerfile
  context: .

services:
  app:
    command: daphne core.asgi:application -b 0.0.0.0 -p ${{PORT}}
    port: ${{PORT}}
    env:
      REDIS_URL: redis://${{REDISUSER}}:${{REDISPASSWORD}}@${{REDISHOST}}:${{REDISPORT}}
    # Optional: add healthchecks to ensure the app is running properly
    # healthcheck:
    #   exec:
    #     cmd: curl -f http://localhost:${{PORT}}/

  worker:
    command: python manage.py runworker -v 2
    env:
      DJANGO_SETTINGS_MODULE: core.settings
      REDIS_URL: redis://${{REDISUSER}}:${{REDISPASSWORD}}@${{REDISHOST}}:${{REDISPORT}}

addons:
  postgresql: latest

databases:
  default:
    url: postgres://${{POSTGRESQL_ADDON_USER}}:${{POSTGRESQL_ADDON_PASSWORD}}@${{POSTGRESQL_ADDON_HOST}}:${{POSTGRESQL_ADDON_PORT}}/${{POSTGRESQL_ADDON_DB}}